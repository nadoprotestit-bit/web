<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Body Balance ‚Äì Admin</title>

<style>
:root { color-scheme: dark; }

body {
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:#0b0f18;
  color:#e9eefc;
}

.wrap {
  max-width: 1100px;
  margin: 40px auto;
  padding: 0 20px;
}

.card {
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 20px;
  padding: 24px;
}

h1 {
  margin-top:0;
  font-size: 26px;
}

.row {
  display:flex;
  gap:12px;
  flex-wrap: wrap;
  align-items: end;
}

label {
  display:block;
  font-size: 12px;
  opacity:.8;
  margin-bottom:6px;
}

input {
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.15);
  background: rgba(0,0,0,.3);
  color:#fff;
  width: 250px;
}

button {
  padding: 10px 16px;
  border-radius: 12px;
  border: none;
  cursor:pointer;
  font-weight: 600;
  transition:.2s;
}

.btn-main {
  background: #ff4d8d;
  color: #0b0f18;
}

.btn-main:hover {
  background:#ff6aa0;
}

.btn-secondary {
  background: rgba(255,255,255,.1);
  color:#fff;
  border:1px solid rgba(255,255,255,.2);
}

.btn-secondary:hover {
  background: rgba(255,255,255,.18);
}

#admin-table {
  width:100%;
  border-collapse: collapse;
  margin-top:25px;
}

#admin-table th,
#admin-table td {
  padding:14px;
  text-align:left;
}

#admin-table th {
  background: rgba(255,255,255,.08);
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: .5px;
}

#admin-table tr:nth-child(even) {
  background: rgba(255,255,255,.03);
}

.today-highlight {
  background: rgba(255,255,255,.06) !important;
}

.cancel-btn {
  background:#e5484d;
  color:white;
  padding:6px 12px;
  border-radius:8px;
}

.cancel-btn:hover {
  background:#ff6369;
}

.toast {
  margin-top:10px;
  font-size:14px;
  opacity:.9;
}
</style>
</head>

<body>

<div class="wrap">
  <div class="card">
    <h1>Admin ‚Äì Rezervace</h1>

    <div class="row">
      <div>
        <label>Admin kl√≠ƒç</label>
        <input id="adminKey" type="password" placeholder="Zadejte admin kl√≠ƒç">
      </div>

      <div>
        <label>Datum</label>
        <input id="dateInput" type="date">
      </div>

      <button class="btn-main" id="loadBtn">Naƒç√≠st</button>
      <button class="btn-secondary" id="refreshBtn">üîÑ Obnovit</button>
      <button class="btn-secondary" id="csvBtn">St√°hnout CSV</button>
    </div>

    <div class="toast" id="msg"></div>

    <table id="admin-table">
      <thead>
        <tr>
          <th>ƒåas</th>
          <th>Jm√©no</th>
          <th>Telefon</th>
          <th>Email</th>
          <th>Slu≈æba</th>
          <th>Pozn√°mka</th>
          <th>Akce</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>
</div>

<script>
const $ = s => document.querySelector(s);

const adminKeyInput = $("#adminKey");
const dateInput = $("#dateInput");
const msg = $("#msg");
const tbody = $("#admin-table tbody");

const LSKEY = "bb_admin_key";
adminKeyInput.value = localStorage.getItem(LSKEY) || "";

const today = new Date().toISOString().slice(0,10);
dateInput.value = today;

let lastItems = [];

function setMsg(text, ok=true){
  msg.textContent = text;
  msg.style.color = ok ? "#e9eefc" : "#ffb3b3";
}

async function api(path, options={}){
  const key = adminKeyInput.value.trim();
  if(!key) throw new Error("Zadejte admin kl√≠ƒç.");
  localStorage.setItem(LSKEY, key);

  const res = await fetch(path, {
    ...options,
    headers: {
      "x-admin-key": key,
      "Content-Type": "application/json",
      ...(options.headers || {})
    }
  });

  const json = await res.json();
  if(!res.ok) throw new Error(json.error || "Chyba API");
  return json;
}

function render(items){
  lastItems = items;
  tbody.innerHTML = "";

  if(!items.length){
    tbody.innerHTML = `<tr><td colspan="6">Pro tento den nejsou ≈æ√°dn√© rezervace.</td></tr>`;
    return;
  }

  items.forEach(item => {
    const tr = document.createElement("tr");

    if(dateInput.value === today){
      tr.classList.add("today-highlight");
    }

    tr.innerHTML = `
        <td><b>${item.startTime}</b></td>
    <td>${item.name}</td>
    <td>${item.phone}</td>
    <td>${item.email || "-"}</td>
    <td>${item.serviceName || item.serviceKey}</td>
    <td>${item.note ? item.note : "-"}</td>
    <td>
      <button class="cancel-btn" data-id="${item.bookingId}">
        Zru≈°it
      </button>
    </td>
    `;

    tbody.appendChild(tr);
  });

  attachCancelHandlers();
}

function attachCancelHandlers(){
  document.querySelectorAll(".cancel-btn").forEach(btn => {
    btn.onclick = async () => {

      const confirmed = confirm("Opravdu chcete tuto rezervaci zru≈°it?");
      if(!confirmed) return;

      const id = btn.dataset.id;

      try{
        await api("/api/admin-cancel", {
          method:"POST",
          body: JSON.stringify({ bookingId:id })
        });

        setMsg("Rezervace zru≈°ena ‚úÖ");
        loadBookings();
      }catch(e){
        setMsg(e.message, false);
      }
    };
  });
}

async function loadBookings(){
  try{
    setMsg("Naƒç√≠t√°m...");
    const date = dateInput.value;
    const data = await api(`/api/admin-list?date=${date}`);
    render(data.items);
    setMsg(`Naƒçteno ${data.items.length} rezervac√≠`);
  }catch(e){
    setMsg(e.message, false);
    render([]);
  }
}

function toCSV(items){
  const rows = [["date","startTime","service","name","phone","email","bookingId"]];
  items.forEach(b=>{
    rows.push([
      b.date,
      b.startTime,
      b.serviceName || b.serviceKey,
      b.name,
      b.phone,
      b.email || "",
      b.bookingId
    ]);
  });
  return rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
}

$("#loadBtn").onclick = loadBookings;
$("#refreshBtn").onclick = loadBookings;

$("#csvBtn").onclick = ()=>{
  const csv = toCSV(lastItems);
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `rezervace-${dateInput.value}.csv`;
  a.click();
};

loadBookings();
</script>

</body>
</html>
