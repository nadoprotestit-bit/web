<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Body Balance – Admin</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f18; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 28px auto; padding: 0 14px; }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); border-radius: 16px; padding: 16px; }
    h1 { margin: 0 0 10px; font-size: 22px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: end; }
    label { display:block; font-size: 12px; opacity:.85; margin: 0 0 6px; }
    input { width: 260px; max-width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); color:#e9eefc; }
    button { padding: 10px 12px; border-radius: 12px; border: 0; cursor:pointer; font-weight: 700; }
    .btn { background: #ff4d8d; color: #0b0f18; }
    .btn2 { background: rgba(255,255,255,.12); color:#e9eefc; border: 1px solid rgba(255,255,255,.14); }
    table { width:100%; border-collapse: collapse; margin-top: 14px; }
    th, td { text-align:left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,.10); font-size: 14px; vertical-align: top; }
    th { font-size: 12px; opacity:.8; }
    .muted { opacity:.75; font-size: 12px; }
    .danger { background: rgba(255,80,80,.15); border: 1px solid rgba(255,80,80,.25); color:#ffd2d2; }
    .toast { margin-top: 10px; font-size: 13px; opacity:.9; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.12); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin – Rezervace</h1>
      <div class="row">
        <div>
          <label>Admin klíč</label>
          <input id="k" type="password" placeholder="Zadejte admin klíč" />
          <div class="muted">Tip: klíč se uloží v prohlížeči (jen na tomto zařízení).</div>
        </div>
        <div>
          <label>Datum</label>
          <input id="d" type="date" />
        </div>
        <button class="btn" id="load">Načíst</button>
        <button class="btn2" id="csv">Stáhnout CSV</button>
      </div>
      <div class="toast" id="msg"></div>

      <div style="margin-top:12px" class="muted">
        Endpointy: <span class="pill">/api/admin-list</span> <span class="pill">/api/admin-cancel</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>Čas</th>
            <th>Služba</th>
            <th>Jméno</th>
            <th>Telefon</th>
            <th>Poznámka</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="t"></tbody>
      </table>
    </div>
  </div>

<script>
  const $ = (s) => document.querySelector(s);
  const keyInput = $("#k");
  const dateInput = $("#d");
  const msg = $("#msg");
  const tbody = $("#t");
  const LSKEY = "bb_admin_key";
  let lastItems = [];

  // init
  keyInput.value = localStorage.getItem(LSKEY) || "";
  const today = new Date();
  dateInput.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

  function setMsg(text, ok=true){
    msg.textContent = text;
    msg.style.color = ok ? "rgba(233,238,252,.9)" : "#ffb3b3";
  }

  async function api(path, options={}){
    const key = keyInput.value.trim();
    if (!key) throw new Error("Zadejte admin klíč.");
    localStorage.setItem(LSKEY, key);

    const res = await fetch(path, {
      ...options,
      headers: {
        "x-admin-key": key,
        "Content-Type": "application/json",
        ...(options.headers || {})
      }
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Chyba API");
    return json;
  }

  function render(items){
    lastItems = items || [];
    tbody.innerHTML = "";
    if (!items || !items.length){
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Pro tento den nejsou žádné rezervace.</td></tr>`;
      return;
    }

    for (const b of items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${b.startTime || ""}</b></td>
        <td>${(b.serviceName || b.serviceKey || "").toString()}</td>
        <td>${(b.name || "").toString()}</td>
        <td>${(b.phone || "").toString()}</td>
        <td class="muted">${(b.note || "").toString()}</td>
        <td><button class="danger" data-id="${b.bookingId}">Zrušit</button></td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("button[data-id]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-id");
        if (!confirm("Opravdu zrušit rezervaci?")) return;
        try{
          await api("/api/admin-cancel", { method:"POST", body: JSON.stringify({ bookingId: id }) });
          setMsg("Rezervace zrušena ✅");
          // reload
          load();
        }catch(e){
          setMsg(e.message, false);
        }
      });
    });
  }

  async function load(){
    try{
      setMsg("Načítám…");
      const date = dateInput.value;
      const data = await api(`/api/admin-list?date=${encodeURIComponent(date)}`);
      render(data.items);
      setMsg(`Načteno: ${data.items.length} rezervací`);
    }catch(e){
      setMsg(e.message, false);
      render([]);
    }
  }

  function toCSV(items){
    const rows = [
      ["date","startTime","service","name","phone","email","note","bookingId"]
    ];
    for (const b of items){
      rows.push([
        b.date || "",
        b.startTime || "",
        (b.serviceName || b.serviceKey || "").toString(),
        (b.name || "").toString(),
        (b.phone || "").toString(),
        (b.email || "").toString(),
        (b.note || "").toString().replace(/\n/g," "),
        b.bookingId || ""
      ]);
    }
    return rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  }

  $("#load").addEventListener("click", load);
  $("#csv").addEventListener("click", () => {
    const csv = toCSV(lastItems);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `rezervace-${dateInput.value}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // enter to load
  keyInput.addEventListener("keydown", (e) => { if (e.key === "Enter") load(); });
  dateInput.addEventListener("change", load);

  // auto load
  load();
</script>
</body>
</html>
